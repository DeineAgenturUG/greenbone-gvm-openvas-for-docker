{%- import "macros/variables.njk" as gbv -%}
{% include "head_variables.njk" %}

{{ gbv.from(gvm_build.IMAGE.IMAGE_BUILD+build_target, 'build_base', 'build') }}
{{ gbv.args_empty(gvm_build.BUILD_ENV) -}}
{{ gbv.args_empty(gvm_build.VERSION) -}}

# Download and install gvm-libs
RUN --mount=type=cache,mode=0755,target=/root/.dl \
    wget -N -q -O "/root/.dl/gvm-libs-${GVM_LIBS_VERSION}.tar.gz" "https://github.com/greenbone/gvm-libs/archive/refs/tags/v${GVM_LIBS_VERSION}.tar.gz" \
    && wget -N -q -O "/root/.dl/gvm-libs-${GVM_LIBS_VERSION}.tar.gz.asc" "https://github.com/greenbone/gvm-libs/releases/download/v${GVM_LIBS_VERSION}/gvm-libs-${GVM_LIBS_VERSION}.tar.gz.asc" \
    && gpg --verify "/root/.dl/gvm-libs-${GVM_LIBS_VERSION}.tar.gz.asc" "/root/.dl/gvm-libs-${GVM_LIBS_VERSION}.tar.gz" \
    && tar -C "${SOURCE_DIR}" -xvzf "/root/.dl/gvm-libs-${GVM_LIBS_VERSION}.tar.gz" \
    && mkdir -p "${BUILD_DIR}/gvm-libs" && cd "${BUILD_DIR}/gvm-libs" \
    && cmake "${SOURCE_DIR}/gvm-libs-${GVM_LIBS_VERSION}" \
    -DCMAKE_INSTALL_PREFIX=${INSTALL_PREFIX} \
    -DCMAKE_BUILD_TYPE=Release \
    -DSYSCONFDIR=/etc \
    -DLOCALSTATEDIR=/var \
    && make "-j$(nproc)"\
    && make DESTDIR="${INSTALL_DIR}" install


FROM scratch
{{ gbv.arg('INSTALL_DIR') -}}
COPY --from=build ${INSTALL_DIR} /
