{%- import "macros/variables.njk" as gbv -%}
{% include "head_variables.njk" %}

{{ gbv.from(gvm_build.IMAGE.IMAGE_DEBIAN,gvm_build.IMAGE.IMAGE_DEBIAN_TAG, 'base') }}
{{ gbv.args_empty(gvm_build.BUILD_ENV) -}}
{{ gbv.args_empty(gvm_build.VERSION) -}}

ENV DEBIAN_FRONTEND=noninteractive \
    LANG=C.UTF-8

RUN apt-get update \
    && apt-get -yq upgrade \
    && apt-get install -yq \
        apt-utils \
        coreutils \
        build-essential \
        cmake \
        git \
        curl \
        gnupg \
        lsb-release \
        pkg-config \
        python3 \
        python3-dev \
        python3-pip \
        sudo \
        wget \
    && echo 'deb http://deb.debian.org/debian bullseye-backports main' | tee /etc/apt/sources.list.d/backports.list \
    && apt-get update \
    && apt-get -yq upgrade \
    && echo "Acquire::http::Proxy \"${http_proxy}\";" | tee /etc/apt/apt.conf.d/30proxy \
    && echo "APT::Install-Recommends \"0\" ; APT::Install-Suggests \"0\" ;" | tee /etc/apt/apt.conf.d/10no-recommend-installs \
    && mkdir -p "${SOURCE_DIR}" \
    && mkdir -p "${BUILD_DIR}" \
    && mkdir -p "${INSTALL_DIR}" \
    && python3 -m pip install --upgrade pip \
    && curl -O https://www.greenbone.net/GBCommunitySigningKey.asc \
       && gpg --import <GBCommunitySigningKey.asc \
       && ( \
           echo 5 \
           && echo y \
           && echo save \
       ) | gpg --command-fd 0 --no-tty --no-greeting -q --edit-key "$(gpg --list-packets <GBCommunitySigningKey.asc | awk '$1=="keyid:"{print$2;exit}')" trust \
    && curl https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor | tee /etc/apt/trusted.gpg.d/apt.postgresql.org.gpg >/dev/null \
    && echo "deb http://apt.postgresql.org/pub/repos/apt/ `lsb_release -cs`-pgdg main" | tee  /etc/apt/sources.list.d/pgdg.list \
    && apt-get update \
    && apt-get -yq upgrade \
    && apt-get -yq install \
      postgresql-${POSTGRESQL_VERSION} \
      postgresql-server-dev-${POSTGRESQL_VERSION} \
      postgresql-client-${POSTGRESQL_VERSION} \
      postgresql-common \
      postgresql-client-common

# Install required dependencies for gvm-libs
RUN apt-get install -yq \
    bison \
    dpkg \
    fakeroot \
    gcc-mingw-w64 \
    gnupg \
    gnutls-bin \
    gpgsm \
    heimdal-dev \
    libgcrypt20-dev \
    libglib2.0-dev \
    libgnutls28-dev \
    libgpgme-dev \
    libgssapi3-heimdal \
    libhdb9-heimdal \
    libhiredis-dev \
    libical-dev \
    libksba-dev \
    libldap2-dev \
    libmicrohttpd-dev \
    libnet1 \
    libnet1-dev \
    libpcap-dev \
    libpopt-dev \
    libpq-dev \
    libradcli-dev \
    libsnmp-dev \
    libssh-gcrypt-dev \
    libunistring-dev \
    libxml2-dev \
    nmap \
    nsis \
    openssh-client \
    perl-base \
    python3 \
    python3-cffi \
    python3-defusedxml \
    python3-deprecated \
    python3-impacket \
    python3-lxml \
    python3-packaging \
    python3-paho-mqtt \
    python3-paramiko \
    python3-pip \
    python3-psutil \
    python3-redis \
    python3-setuptools \
    python3-wrapt \
    rpm \
    rsync \
    smbclient \
    snmp \
    socat \
    sshpass \
    uuid-dev  \
    wget \
    xml-twig-tools \
    xmlstarlet \
    xsltproc \
    zip \
    && python3 -m pip install --upgrade setuptools
